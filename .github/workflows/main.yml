name: Python Bot Runner 24/7
on:
  workflow_dispatch:
  schedule:
    - cron: '50 */5 * * *'  # ÙƒÙ„ 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©

jobs:
  setup-and-run:
    runs-on: windows-latest
    timeout-minutes: 350  # 5 Ø³Ø§Ø¹Ø§Øª Ùˆ50 Ø¯Ù‚ÙŠÙ‚Ø©
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: Upgrade pip
      run: |
        python -m pip install --upgrade pip
        pip --version
        
    - name: Install Telegram Bot Libraries
      run: |
        pip install pyTelegramBotAPI requests
        
    - name: Create Python Script
      run: |
        # 1. Ø§Ø­ÙØ¸ ØªÙˆÙƒÙŠÙ† Ø¨ÙˆØªÙƒ (ØªØ¹Ø¯Ù„ Ø§Ù„Ù‚ÙŠÙ…Ø©)
        $token = "8459989963:AAF8yaQ4aw7rkyUzw2WsWQEB51vaG2Nk2c4"
        $adminId = "7367658915"
        
        # 2. ÙƒÙˆØ¯ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
        $botCode = @"
import telebot
import os
import subprocess
import time
import threading

TOKEN = "$token"
ADMIN_ID = $adminId

bot = telebot.TeleBot(TOKEN)

@bot.message_handler(commands=['start'])
def start(message):
    if message.from_user.id == ADMIN_ID:
        bot.reply_to(message, "âœ… Ø§Ù„Ø¨ÙˆØª Ø´ØºØ§Ù„ Ø¹Ù„Ù‰ GitHub Actions!\n\nØ£Ø±Ø³Ù„ Ø£ÙŠ Ø£Ù…Ø±:")
    else:
        bot.reply_to(message, "âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©!")

@bot.message_handler(func=lambda message: True)
def echo_all(message):
    if message.from_user.id == ADMIN_ID:
        try:
            # ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø± Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
            result = subprocess.run(message.text, shell=True, capture_output=True, text=True, timeout=30)
            
            if result.returncode == 0:
                output = result.stdout[:4000]  # Ù‚Øµ Ø§Ù„Ù†Ø§ØªØ¬
                bot.reply_to(message, f"âœ… Ø§Ù„Ù†Ø§ØªØ¬:\n```\n{output}\n```", parse_mode='Markdown')
            else:
                error = result.stderr[:4000]
                bot.reply_to(message, f"âŒ Ø®Ø·Ø£:\n```\n{error}\n```", parse_mode='Markdown')
        except Exception as e:
            bot.reply_to(message, f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ†ÙÙŠØ°:\n{e}")
    else:
        bot.reply_to(message, "âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©!")

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª ÙÙŠ thread Ù…Ù†ÙØµÙ„
def run_bot():
    print("ğŸ¤– Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª...")
    bot.infinity_polling(none_stop=True)

# Ø¨Ø¯Ø¡ thread Ù„Ù„Ø¨ÙˆØª
bot_thread = threading.Thread(target=run_bot, daemon=True)
bot_thread.start()

# Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Workflow Ø´ØºØ§Ù„
print("â° Ø§Ù„Ø¨ÙˆØª ÙŠØ¹Ù…Ù„...")
while True:
    time.sleep(60)
    print(f"ğŸ”„ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØ¹Ù…Ù„... {time.strftime('%H:%M:%S')}")
"@
        
        # 3. Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù…Ù„Ù
        $botCode | Out-File -FilePath "github_bot.py" -Encoding UTF8
        
        # 4. Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„Ù„ØªØ­Ù‚Ù‚)
        Get-Content "github_bot.py" -TotalCount 10
        
    - name: Run Python Bot
      run: |
        echo "ğŸš€ Ø¨Ø¯Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª..."
        python github_bot.py
        
    - name: Keep Alive (backup)
      if: always()
      run: |
        echo "ğŸ”„ Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØŒ Ù‡Ø°Ù‡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©..."
        # Ø­Ù„ Ø¨Ø¯ÙŠÙ„ Ø¥Ø°Ø§ ØªÙˆÙ‚Ù Ø§Ù„Ø¨ÙˆØª
        $backupCode = @"
import time
import os

print("ğŸ¤– Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªØ¹Ù…Ù„...")

while True:
    print(f"ğŸ•’ Ù„Ø§ ÙŠØ²Ø§Ù„ ÙŠØ¹Ù…Ù„: {time.strftime('%Y-%m-%d %H:%M:%S')}")
    
    # ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø´ØºØ§Ù„
    try:
        import psutil
        for proc in psutil.process_iter(['pid', 'name', 'cmdline']):
            if proc.info['cmdline'] and 'python' in proc.info['cmdline'] and 'github_bot.py' in proc.info['cmdline']:
                print("âœ… Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ÙŠØ¹Ù…Ù„")
                break
        else:
            print("âš ï¸ Ø§Ù„Ø¨ÙˆØª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ ØªÙˆÙ‚ÙØŒ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„...")
            os.system("start python github_bot.py")
    except:
        pass
    
    time.sleep(300)  # Ø§Ù†ØªØ¸Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚
"@
        
        $backupCode | Out-File -FilePath "backup_bot.py" -Encoding UTF8
        start-process python -ArgumentList "backup_bot.py" -NoNewWindow
        
    - name: Send Status to Telegram
      if: always()
      run: |
        # Ø£Ø±Ø³Ù„ Ø¥Ø´Ø¹Ø§Ø± Ù„Ù€ Telegram Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡/ØªÙˆÙ‚Ù
        $status = if ($env:JOB_STATUS -eq "success") { "Ø¨Ø¯Ø£ Ø§Ù„ØªØ´ØºÙŠÙ„ âœ…" } else { "ØªÙˆÙ‚Ù âŒ" }
        $chatId = "7367658915"  # ØºÙŠØ± Ù‡Ø°Ø§ Ù„Ù€ chat ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
        $botToken = "8459989963:AAF8yaQ4aw7rkyUzw2WsWQEB51vaG2Nk2c4"  # ØªÙˆÙƒÙŠÙ† Ø§Ù„Ø¨ÙˆØª
        
        $url = "https://api.telegram.org/bot$botToken/sendMessage"
        $body = @{
            chat_id = $chatId
            text = "ğŸ“¢ GitHub Bot $status`nğŸ•’ $((Get-Date).ToString('yyyy-MM-dd HH:mm:ss'))`nğŸ”— https://github.com/${{ github.repository }}/actions"
        } | ConvertTo-Json
        
        Invoke-RestMethod -Uri $url -Method Post -ContentType "application/json" -Body $body -ErrorAction SilentlyContinue
